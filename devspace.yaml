version: v1beta9
images:
  app:
    image: registry.noizwaves.cloud/fitness
    preferSyncOverRebuild: true
    rebuildStrategy: ignoreContextChanges
    injectRestartHelper: true
    build:
      buildKit:
        inCluster: {}
        args:
          - --cache-to
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
          - --cache-from
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
deployments:
  - name: fitness-dependencies
    kubectl:
      replaceImageTags: false
      manifests:
        - kubernetes/postgres.yaml
        - kubernetes/redis.yaml
        - kubernetes/ide-idea.yaml
  - name: fitness
    kubectl:
      replaceImageTags: true
      manifests:
        - kubernetes/web.yaml
        - kubernetes/sidekiq.yaml
dev:
  sync:
  - labelSelector:
      name: ide-idea
    containerName: ide-idea
    initialSync: preferLocal
    localSubPath: idea
    containerPath: /home/projector-user/.config/JetBrains/IntelliJIdea2020.2
    excludePaths:
      - '**'
      - '!/keymaps/'
      - '!/options/'
  ports:
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3000
          remotePort: 3000
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3035
          remotePort: 3035
    - labelSelector:
        name: ide-idea
      forward:
        - port: 8887
          remotePort: 8887
  logs:
    disabled: true
commands:
  - name: db-setup
    command: devspace enter --pod fitness-web --container web -- bin/rails db:setup
  - name: rails-test
    command: devspace enter --pod fitness-web --container web -- bin/rails test
profiles:
- name: local
  merge:
    images:
      app:
        build:
          buildKit:
            inCluster: null
            skipPush: true
            preferMinikube: true
