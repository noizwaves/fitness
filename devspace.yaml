version: v1beta9
images:
  app:
    image: registry.noizwaves.cloud/fitness
    preferSyncOverRebuild: true
    rebuildStrategy: ignoreContextChanges
    injectRestartHelper: true
    build:
      buildKit:
        inCluster: {}
        args:
          - --cache-to
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
          - --cache-from
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
deployments:
  - name: fitness-dependencies
    kubectl:
      replaceImageTags: false
      manifests:
        - kubernetes/postgres.yaml
        - kubernetes/redis.yaml
  - name: fitness
    kubectl:
      replaceImageTags: true
      manifests:
        - kubernetes/web.yaml
        - kubernetes/sidekiq.yaml
dev:
  sync:
  - labelSelector:
      name: fitness-web
    containerName: web
    excludePaths: &exclude-paths
      - .git/
      - .gitignore
      - .devspace
      - .idea
      - .tool-versions
      - .vscode/
      - cluster
      - kubernetes
      - node_modules
      - tmp
      - log
      - public/packs
      - Dockerfile
      - docker-compose.yml
      - devspace.yaml
    uploadExcludePaths: &upload-exclude-paths
      - '!log/.keep'
      - '!tmp/.keep'
    onUpload: &on-upload
      restartContainer: false
      execRemote:
        onFileChange:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
        onBatch:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
  - labelSelector:
      name: fitness-web
    containerName: webpack
    excludePaths: *exclude-paths
    uploadExcludePaths: *upload-exclude-paths
    onUpload: *on-upload
  - labelSelector:
      name: fitness-sidekiq
    containerName: sidekiq
    excludePaths: *exclude-paths
    uploadExcludePaths: *upload-exclude-paths
    onUpload: *on-upload
  ports:
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3000
          remotePort: 3000
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3035
          remotePort: 3035
  logs:
    disabled: true
commands:
  - name: db-setup
    command: devspace enter --pod fitness-web --container web -- bin/rails db:setup
  - name: rails-test
    command: devspace enter --pod fitness-web --container web -- bin/rails test
profiles:
- name: local
  merge:
    images:
      app:
        build:
          buildKit:
            inCluster: null
            skipPush: true
            preferMinikube: true
            args: []
