version: v1beta9
images:
  app:
    image: registry.noizwaves.cloud/fitness
    preferSyncOverRebuild: true
    rebuildStrategy: ignoreContextChanges
    injectRestartHelper: true
    build:
      buildKit:
        inCluster: {}
deployments:
  - name: fitness-dependencies
    kubectl:
      replaceImageTags: false
      manifests:
        - kubernetes/postgres.yaml
        - kubernetes/redis.yaml
  - name: fitness
    kubectl:
      replaceImageTags: true
      manifests:
        - kubernetes/web.yaml
        - kubernetes/sidekiq.yaml
dev:
  sync:
  - labelSelector:
      name: fitness-web
    containerName: web
    excludePaths:
      - .git/
      - .gitignore
      - .devspace
      - cluster
    uploadExcludePaths:
      - node_modules
      - kubernetes
      - log
      - '!log/.keep'
      - tmp
      - '!tmp/.keep'
      - Dockerfile
      - docker-compose.yml
      - .tool-versions
      - .idea
      - devspace.yaml
      - public/packs
    downloadExcludePaths:
      - tmp
      - node_modules
      - log
      - public/packs
    onUpload:
      restartContainer: false
      execRemote:
        onFileChange:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
        onBatch:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
  - labelSelector:
      name: fitness-web
    containerName: webpack
    excludePaths:
      - .git/
      - .gitignore
      - .devspace
      - cluster
    uploadExcludePaths:
      - node_modules
      - kubernetes
      - log
      - '!log/.keep'
      - tmp
      - '!tmp/.keep'
      - Dockerfile
      - docker-compose.yml
      - .tool-versions
      - .idea
      - devspace.yaml
      - public/packs
    downloadExcludePaths:
      - tmp
      - node_modules
      - log
      - public/packs
    onUpload:
      restartContainer: false
      execRemote:
        onFileChange:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
        onBatch:
          command: bash
          args:
            - /app/bin/install_dependencies.sh
  ports:
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3000
          remotePort: 3000
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3035
          remotePort: 3035
  logs:
    disabled: true
commands:
  - name: rails-test
    command: devspace enter --pod fitness-web --container web -- bin/rails test
profiles:
- name: local
  merge:
    images:
      app:
        build:
          buildKit:
            inCluster: null
            skipPush: true
            preferMinikube: true
