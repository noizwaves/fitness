version: v1beta9
images:
  app:
    image: registry.noizwaves.cloud/fitness
    preferSyncOverRebuild: true
    rebuildStrategy: ignoreContextChanges
    injectRestartHelper: true
    build:
      buildKit:
        inCluster: {}
        command: [buildx]
        args:
          - --cache-to
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
          - --cache-from
          - type=registry,ref=registry.noizwaves.cloud/fitness-cache
deployments:
  - name: fitness-dependencies
    kubectl:
      replaceImageTags: false
      manifests:
        - kubernetes/postgres.yaml
        - kubernetes/redis.yaml
  - name: fitness
    kubectl:
      replaceImageTags: true
      manifests:
        - kubernetes/web.yaml
        - kubernetes/sidekiq.yaml
dev:
  ports:
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3000
          remotePort: 3000
    - labelSelector:
        name: fitness-web
      forward:
        - port: 3035
          remotePort: 3035
  logs:
    disabled: true
commands:
  - name: db-setup
    command: devspace enter --pod fitness-web --container web -- bin/rails db:setup
  - name: rails-test
    command: devspace enter --pod fitness-web --container web -- bin/rails test
  - name: get-code-server-config
    command: devspace enter --container web --silent -- cat /root/.config/code-server/config.yaml
profiles:
- name: local
  merge:
    images:
      app:
        build:
          buildKit:
            inCluster: null
            skipPush: true
            preferMinikube: true
